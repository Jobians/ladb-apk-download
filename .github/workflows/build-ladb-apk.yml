name: Build Signed LADB APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Clone LADB repository  
      run: git clone https://github.com/tytydraco/LADB.git  

    - name: Detect latest "Update version code" commit and version  
      id: detect_version
      run: |
        cd LADB
        # Get the latest commit hash with message "Update version code"
        LATEST_COMMIT=$(git log --grep="Update version code" -1 --format="%H")
        echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT

        # Get commit short hash
        SHORT_HASH=$(echo $LATEST_COMMIT | cut -c1-7)
        echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT

        # Get versionName from build.gradle
        VERSION_NAME=$(grep 'versionName ' app/build.gradle | head -n1 | sed -E 's/.*versionName "([^"]+)".*/\1/')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

        # Generate tag name like v2.5.6
        echo "tag_name=v$VERSION_NAME" >> $GITHUB_OUTPUT

    - name: Set up JDK 17  
      uses: actions/setup-java@v4  
      with:  
        java-version: '17'  
        distribution: 'temurin'  

    - name: Restore Keystore  
      run: |  
        mkdir -p LADB/app  
        echo "$KEYSTORE_FILE" | base64 --decode > LADB/app/ladb-apk-release-key.jks  
      env:  
        KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}  

    - name: Build Signed Release APK  
      run: |  
        cd LADB  
        chmod +x ./gradlew  
        ./gradlew assembleRelease \
          -PRELEASE_ANTIPIRACY=false \
          -Pandroid.injected.signing.store.file=$(pwd)/app/ladb-apk-release-key.jks \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

    - name: Rename APK to include version
      run: |
        VERSION=${{ steps.detect_version.outputs.version_name }}
        mv LADB/app/build/outputs/apk/release/app-release.apk LADB/app/build/outputs/apk/release/LADB-v$VERSION.apk

    - name: Create GitHub Release and Upload APK
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.detect_version.outputs.tag_name }}
        name: LADB Release ${{ steps.detect_version.outputs.version_name }}
        files: LADB/app/build/outputs/apk/release/LADB-v${{ steps.detect_version.outputs.version_name }}.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
